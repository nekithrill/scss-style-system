@use 'sass:meta';
@use 'sass:map';
@use 'sass:list';

/// Validate theme map structure
/// Recursively checks if theme contains all required keys from schema
/// Warns about unexpected keys not in schema or leaf keys whitelist
///
/// @param {Map} $theme-map - Theme map to validate
/// @param {Map} $required-keys - Required keys structure from schema
/// @param {List} $allowed-leaf-keys - Whitelisted keys at deepest level (e.g., _, hover, active, error)
/// @param {String|Null} $parent - Internal recursion path (do not pass manually)
///
/// @example scss
///   @include validate-theme($dark, $theme-required-keys, $theme-leaf-keys);
///
///   // Error if missing required key:
///   // ⚠️ Theme map is missing required key `main.bg`!
///
///   // Warning if unexpected key:
///   // ⚠️ Theme map contains unexpected key `main.unknown` that is not in the schema!

@mixin validate-theme(
	$theme-map,
	$required-keys,
	$allowed-leaf-keys,
	$parent: null
) {
	@if meta.type-of($theme-map) != 'map' {
		@error "validate-theme: Expected $theme-map to be a map, got `#{meta.type-of($theme-map)}`.";
	}

	@if meta.type-of($required-keys) != 'map' {
		@error "validate-theme: Expected $required-keys to be a map, got `#{meta.type-of($required-keys)}`.";
	}

	@each $key, $value in $required-keys {
		$full-key: if($parent != null, '#{$parent}.#{$key}', $key);

		@if not map.has-key($theme-map, $key) {
			@error "⚠️ Theme map is missing required key `#{$full-key}`!";
		} @else if meta.type-of($value) == 'map' {
			@include validate-theme(
				map.get($theme-map, $key),
				$value,
				$allowed-leaf-keys,
				$full-key
			);
		}
	}

	@each $key, $value in $theme-map {
		$full-key: if($parent != null, '#{$parent}.#{$key}', $key);

		$is-allowed-leaf: if(
			list.index($allowed-leaf-keys, $key) != null,
			true,
			false
		);

		@if not map.has-key($required-keys, $key) and not $is-allowed-leaf {
			@warn "⚠️ Theme map contains unexpected key `#{$full-key}` that is not in the schema or leaf keys whitelist!";
		}
	}
}
